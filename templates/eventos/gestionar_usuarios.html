{% extends 'partials/base.html' %}
{% block title %}Gestionar Usuarios{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto mt-10 px-4">
  <h2 class="text-3xl font-extrabold text-indigo-700 mb-6">游논 Usuarios registrados</h2>

  <div class="bg-white shadow rounded-lg p-6 overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usuario</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rol</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha registro</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for info in usuarios_info %}
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 text-sm text-gray-800">{{ info.usuario.username }}</td>
          <td class="px-6 py-4 text-sm text-gray-600">{{ info.usuario.email }}</td>
          <td class="px-6 py-4 text-sm text-gray-600">{{ info.usuario.rol }}</td>
          <td class="px-6 py-4 text-sm text-gray-600">{{ info.usuario.date_joined|date:"d/m/Y H:i" }}</td>
          <td class="px-6 py-4">
            <button 
              class="bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 text-sm"
              onclick="openModal({{ info.usuario.id }}, '{{ info.usuario.username }}', '{{ info.usuario.rol }}', {{ info.tickets_count }}, {{ info.eventos_count }})">
              Eliminar
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal oculto por defecto -->
<div id="deleteModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
    <h3 class="text-lg font-bold text-red-600 mb-4">丘멆잺 Advertencia</h3>
    <p id="modalMessage" class="text-gray-700 mb-4"></p>
    <div class="flex justify-end gap-3">
      <button onclick="closeModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">
        Cancelar
      </button>
      <form id="deleteForm" method="post">
        {% csrf_token %}
        <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
          S칤, eliminar
        </button>
      </form>
    </div>
  </div>
</div>

<script>
function openModal(id, username, rol, tickets, eventos) {
  const modal = document.getElementById('deleteModal');
  const message = document.getElementById('modalMessage');
  const form = document.getElementById('deleteForm');

  let texto = `쯉eguro que deseas eliminar al usuario ${username}?<br><br>`;
  if (rol === 'asistente') {
    texto += `Este usuario tiene <strong>${tickets}</strong> tickets que se perder치n.`;
  } else if (rol === 'organizador') {
    texto += `Este usuario es organizador y tiene <strong>${eventos}</strong> eventos creados que se eliminar치n.`;
  } else {
    texto += `Este usuario ser치 eliminado permanentemente.`;
  }

  message.innerHTML = texto;
  form.action = "{% url 'eliminar_usuario' 0 %}".replace("0", id);

  modal.classList.remove('hidden');
}

function closeModal() {
  document.getElementById('deleteModal').classList.add('hidden');
}
</script>
{% endblock %}
